<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>주주총회</title>
  <link rel="shortcut icon" href="#">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"
          integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/common.js"></script>
  <script>
    let userId = -1;

    async function getCategoryName(id) {
      try {
        const response = await $.ajax({
          type: 'GET',
          url: `/v1/categories/${id}`
        });

        let category = response['data'];
        let name = category['name'];
        console.log(name);
        return name;
      } catch (error) {
        alert(error['responseJSON']['msg']);
        return null;
      }
    }

    $(document).ready(async function () {
      getCategory();

      try {
        const response = await $.ajax({
          type: 'GET',
          url: `/v1/users/myprofile`
        });

        userInfo = response['data'];
        userId = userInfo['id'];
        $('#loginId').text(userInfo['loginId']);
        $('#nickname').text(userInfo['nickname']);
        $('#email').text(userInfo['email']);
        let firstId = userInfo['firstPreferredCategoryId'];
        let secondId = userInfo['secondPreferredCategoryId'];
        console.log(userInfo);
        console.log(firstId+" "+secondId);

        let firstName = await getCategoryName(firstId);
        let secondName = await getCategoryName(secondId);

        console.log(firstName + " " + secondName);

        $('#firstPreferredCategory').text(firstName);
        $('#secondPreferredCategory').text(secondName);

        let image = userInfo['image'];
        if (!image) {
          image = "/images/default_user_image.png"
        }
        $('#image').attr('src', image);
      } catch (error) {
        alert(error['responseJSON']['msg']);
      }

      $('#image').click(function () {
        $('#imageInput').click();
      });

      // 파일 입력 창의 내용이 변경되면 호출되는 함수
      $('#imageInput').change(function (event) {
        // 선택한 파일 정보 가져오기
        const selectedFile = event.target.files[0];

        if (selectedFile) {
          // 선택한 파일을 미리보기에 표시
          console.log(userId);
          $('#image').attr('src', URL.createObjectURL(selectedFile));
          const formData = new FormData();
          formData.append('image', selectedFile);

          $.ajax({
            type: 'POST',
            url: `/v1/users/${userId}`,
            data: formData,
            enctype: "multipart/form-data",
            contentType: false,
            processData: false,
            success: function (response) {
              alert(response['msg']);
              window.location.reload();
            },
            error(error, status, request) {
              alert(error['responseJSON']['msg'])
            }
          })
          ;
        }
      });
    });

    function getCategory() {
      $.ajax({
        type: "GET",
        url: `/v1/categories`,
        success: function (response) {
          let categories = response['data'];
          console.log(categories);
          for (let i = 0; i < categories.length; i++) {
            let category = categories[i];
            let id = category['id'];
            let name = category['name'];
            let html = `<option value=${id}>${name}</option>`
            $('#firstPreferredCategoryId').append(html);
            $('#secondPreferredCategoryId').append(html);
          }
        },
        error(error, status, request) {
        }
      });

    }

    function showEditArea() {
      $('#edit-area').show();
      $('#show-area').hide();
    }

    function showOriginal() {
      $('#edit-area').hide();
      $('#show-area').show();
    }

    function updateProfile() {
      let nickname = $('#edit-nickname').val();
      let currentPassword = $('#current_password').val();
      let password = $('#edit-password').val();
      let passwordCheck = $('#edit-passwordCheck').val();
      let firstPreferredCategoryId = $('#firstPreferredCategoryId').val();
      let secondPreferredCategoryId = $('#secondPreferredCategoryId').val();
      let email = $('#edit-email').val();

      console.log(firstPreferredCategoryId+" "+secondPreferredCategoryId);

      if (firstPreferredCategoryId === secondPreferredCategoryId) {
        alert("1순위 선호 주종과 2순위 선호 주종이 같습니다!");
        return;
      }

      let data = {
        "nickname": nickname,
        "currentPassword":currentPassword,
        "password": password,
        "passwordCheck": passwordCheck,
        "firstPreferredCategoryId": firstPreferredCategoryId,
        "secondPreferredCategoryId": secondPreferredCategoryId,
        "email": email
      }

      $.ajax({
        type: 'PATCH',
        url: `/v1/users/${userId}`,
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (response) {
          alert(response['msg']);
          window.location.reload();
        },
        error(error, status, request) {
          console.log(error);
          alert(error['responseJSON']['msg'])
        }
      })
    }

  </script>


</head>
<body>

<div class="container">
  <header
      class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
    <div class="col-md-3 mb-2 mb-md-0">
      <a href="/" class="d-inline-flex link-body-emphasis text-decoration-none">
        주주 총회
      </a>
    </div>

    <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0" id="main_menu">
      <li><a href="#" class="nav-link px-2 link-secondary">주주 총회 소개</a></li>
      <li><a href="#" class="nav-link px-2">내가 찜한 주류</a></li>
      <li><a href="#" class="nav-link px-2">내가 쓴 리뷰</a></li>
      <li><a href="#" class="nav-link px-2">고객 센터</a></li>
    </ul>

    <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0" id="admin_menu">
      <li><a href="/admin" class="nav-link px-2">회원 관리</a></li>
      <li><a href="/admin/category" class="nav-link px-2">카테 고리 관리</a></li>
      <li><a href="/admin/product" class="nav-link px-2">상품 관리</a></li>
      <li><a href="/admin/report" class="nav-link px-2">제보 관리</a></li>
      <li><a href="/admin/chat" class="nav-link px-2">고객 센터</a></li>
    </ul>

    <div class="col-md-3 text-end">
      <button id="sign-in-btn" class="btn btn-info" onclick="location.href='/login'">
        Sign in
      </button>
      <button id="sign-up-btn" class="btn btn-outline-info" onclick="location.href='/signup'">
        Sign up
      </button>
      <button class="btn btn-info" id="mypage">
        <span id="header_nickname" onclick="location.href='/mypage'"></span>님의 마이 페이지
      </button>
      <button class="btn btn-outline-info" id="logout-btn" onclick="logout()">
        Logout
      </button>
    </div>
  </header>
</div>
<div style="width: 40%;margin: auto">
  <div style="display: flex;align-items: center;justify-content: center;">
    <img id="image"
         style="width: 250px;height: 250px; object-fit: cover; border-radius: 200px;">
    <input type="file" id="imageInput" style="display: none;" accept="image/*">
  </div>
  <div id="show-area" style="margin-top: 50px">
    <div style="margin-bottom: 20px;">loginId :
      <span id="loginId"></span>
    </div>
    <div style="margin-bottom: 20px;">nickname :
      <span id="nickname"></span>
    </div>
    <div style="margin-bottom: 20px;">
      email:
      <span id="email"></span>
    </div>
    <div style="margin-bottom: 20px;">
      1순위 선호 주종 :<span id="firstPreferredCategory"></span>
    </div>
    <div style="margin-bottom: 20px;">
      2순위 선호 주종 :<span id="secondPreferredCategory"></span>
    </div>
    <button class="btn btn-primary" onclick="showEditArea()"> 수정</button>
  </div>
  <div id="edit-area" style="display:none; margin-top: 50px">

    <div style="margin-bottom: 20px;">닉네임 :
      <input type="text" id="edit-nickname">
    </div>

    <div style="margin-bottom: 20px;">현재 비밀번호 :
      <input type="password" id="current_password">
    </div>

    <div style="margin-bottom: 20px;">새 비밀번호 :
      <input type="password" id="edit-password">
    </div>

    <div style="margin-bottom: 20px;">비밀번호 확인 :
      <input type="password" id="edit-passwordCheck">
    </div>


    <div style="margin-bottom: 20px;">
      email:
      <input type="email" id="edit-email"></input>
    </div>

    <label for="firstPreferredCategoryId">1순위 선호 주종</label>
    <div class="form-floating" style="margin-top: 20px">

      <select class="form-select" id="firstPreferredCategoryId"
              aria-label="Floating label select example">
        <option selected>주종을 선택해 주세요</option>
      </select>
    </div>

    <label for="secondPreferredCategoryId">2순위 선호 주종</label>
    <div class="form-floating" style="margin-top: 20px">
      <select class="form-select" id="secondPreferredCategoryId"
              aria-label="Floating label select example">
        <option selected>주종을 선택해 주세요</option>
      </select>
    </div>

    <button onclick="updateProfile()" class="btn btn-primary"> 저장</button>
    <button onclick="showOriginal()" class="btn btn-light"> 취소</button>
  </div>
</div>

</body>